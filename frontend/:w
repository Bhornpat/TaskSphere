'use client'

import { useEffect, useState } from 'react'
import { useSearchParams } from 'next/navigation'

interface Task {
	id: number
	title: string
	description: string
	due_date: string
	status: string
}

export default function Dashboard() {
	const [tasks, setTasks] = useState<Task[]>([])
	const [error, setError] = useState('')
	const [showModal, setShowModal] = useState(false)
	const [newTask, setNewTask] = useState({ title: '', description: '', due_date: '' })
	const [editModalTask, setEditModalTask] = useState<Task | null>(null)
	const [editForm, setEditForm] = useState({ title: '', description: '', due_date: '' })
	const [showDeleteModal, setShowDeleteModal] = useState(false);
	const [taskToDelete, setTaskToDelete] = useState(null);
	const [editError, setEditError] = useState('')
	const [addError, setAddError] = useState('')
	const [expandedTaskId, setExpandedTaskId] = useState<{ [id: number]: boolean }>({})
	const [stickerConfigTask, setStickerConfigTask] = useState<Task | null>(null)
	const [stickerEmoji, setStickerEmoji] = useState("üåü")
	const [stickerColor, setStickerColor] = useState("#ffffff")
	const [stickerMood, setStickerMood] = useState("inspired")




	useEffect(() => {
		const fetchTasks = async () => {
			const token = localStorage.getItem('token')
			if (!token) {
				setError('User not authenticated')
				return
			}

			try {
				const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks`, {
					method: 'GET',
					headers: {
						Authorization: `Bearer ${token}`,
					},
				})

				if (!res.ok) {
					throw new Error('Failed to fetch tasks')
				}

				// const data = await res.json()
				// setTasks(data)




			} catch (err: unknown) {
				if (err instanceof Error) {
					setError(err.message)
				} else {
					setError('Something went wrong')
				}
			}

		}

		fetchTasks()
	}, [])

	const handleAddTask = async () => {
		// Add validation
		if (!newTask.title.trim() || !newTask.description.trim() || !newTask.due_date) {
			setAddError("All fields are required.")
			return
		}
		const token = localStorage.getItem('token')
		if (!token) return

		try {
			const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					Authorization: `Bearer ${token}`,
				},
				body: JSON.stringify({
					...newTask,
					status: 'pending', // required by backend
				})
			})

			if (!res.ok) throw new Error('Failed to create task')

			const created = await res.json()
			setTasks(prev => [...prev, created])
			setShowModal(false)
			setNewTask({ title: '', description: '', due_date: '' })
		} catch {
			setAddError('Something went wrong')

		}
	}

	return (
		<div className="p-6">
			{error && <p className="text-red-500 mb-4 text-center">{error}</p>}

			<div className='px-6 pt-12 flex justify-center items-center'>
				<button
					onClick={() => setShowModal(true)}
					className="my-6 px-6 py-4 my-6 rounded-2xl bg-gradient-to-br from-pink-600 via-red-500 to-yellow-400 text-white text-xl shadow-md font-bold hover:brightness-110 transition duration-200"
				>
					Add Task Here
				</button>




				{/*mobile toggle */}

			</div>
			<div className="space-y-6 px-5 ">
				{tasks.map(task => (
					<div key={task.id}
						className={`p-5 rounded-lg border flex flex-col md:flex-row justify-between  ${task.status === 'done' ? 'bg-green-100' : 'bg-yellow-50'}`}
					>
						{/* Left side: content that expands */}
						<div className="relative flex-1 min-w-0 z-0">


							{/*  Mobile-only emoji status toggle button */}
							<div className="relative z-0">
								<button
									onClick={async () => {
										const token = localStorage.getItem('token');
										if (!token) return;

										const newStatus = task.status === 'done' ? 'pending' : 'done';

										const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks/${task.id}`, {
											method: 'PUT',
											headers: {
												'Content-Type': 'application/json',
												Authorization: `Bearer ${token}`,
											},
											body: JSON.stringify({
												title: task.title,
												description: task.description,
												due_date: task.due_date,
												status: newStatus,
											}),
										});

										if (res.ok) {
											const updated = await res.json();
											setTasks((prev) =>
												prev.map((t) => (t.id === updated.id ? updated : t))
											);
										} else {
											alert('Failed to update task status');
										}
									}}
								>
									<span className={`absolute top-0 right-0 z-10 rounded-full w-10 h-10 flex items-center justify-center flex items-center gap-1 text-black text-sm font-semibold hover:scale-105 transition duration-300 shadow-md cursor-pointer $ md:hidden ${task.status === 'done' ? 'bg-green-500' : 'bg-yellow-400'}`}
									>
										{task.status === 'done' ? 'üéâ' : '‚è≥'}
									</span>								</button>
							</div>



							{/*title*/}
							<div className="relative z-20 pb-6">
								<h2 className="font-bold mb-2 text-xl text-gray-700 break-words whitespace-normal leading-relaxed z-50">{task.title}</h2>
								{/*description*/}
								<div className="text-md mr-2 text-gray-700 leading-relaxed font-mono break-words whitespace-normal"
								>
									{task.description.length > 25 ? (
										expandedTaskId[task.id] ? (
											<>
												<p className="break-words whitespace-normal">{task.description}</p>
												<button
													onClick={() =>
														setExpandedTaskId(prev => ({ ...prev, [task.id]: false }))
													}
													className="text-xs text-gray-500 underline mt-1"
												>							Show less ‚ñ≤
												</button>
											</>
										) : (
											<>
												<p className="break-words whitespace-normal">{task.description.slice(0, 100) + '...'} </p>
												<button
													onClick={() => setExpandedTaskId(prev => ({ ...prev, [task.id]: true }))
													}
													className="text-xs text-gray-500 underline mt-1"
												>
													Read more ‚ñº
												</button>
											</>
										)
									) : (
										<p className="break-words whitespace-normal">{task.description}</p>
									)}
								</div>


								{/*due date*/}
								<p className="mt-2 text-sm text-gray-500">Due: {task.due_date.split('T')[0]}</p>


								<div className='flex flex-row gap-2 mt-3 items-center mt-3'>
									<button
										onClick={() => {
											setEditModalTask(task)
											setEditForm({
												title: task.title,
												description: task.description,
												due_date: task.due_date.split('T')[0],
											})
										}}
										className="px-3 py-2 md:px-4 md:py-2 rounded-full bg-green-600 text-white text-xs shadow-md font-bold hover:brightness-110 transition duration-200"
									>
										Edit
									</button>

									<button
										onClick={() => {
											setTaskToDelete(task.id);
											setShowDeleteModal(true);
										}}
										className="px-4 py-2 rounded-full bg-red-600 text-white text-xs shadow-md font-bold hover:brightness-110 transition duration-200"
									>
										Delete
									</button>

									{/* Make Sticker */}
									<button
										onClick={() => {
											setStickerConfigTask(task)
											setStickerEmoji("üí°")
											setStickerColor("#fffacd")
											setStickerMood("focus")
										}}
										className="px-4 py-2 rounded-full bg-gradient-to-br from-blue-600 via-purple-500 to-pink-400 text-white text-xs shadow-md font-bold hover:brightness-110 transition duration-200"
									>
										Make Sticker
									</button>
								</div>
							</div>
						</div>
						{/* toggle status */}
						<div className="self-start md:self-center shrink-0 w-[100px] text-right md:mt-0 ml-4">
							<button
								onClick={async () => {
									const token = localStorage.getItem('token')
									if (!token) return

									const newStatus = task.status === 'done' ? 'pending' : 'done'

									const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks/${task.id}`, {
										method: 'PUT',
										headers: {
											'Content-Type': 'application/json',
											Authorization: `Bearer ${token}`,
										},
										body: JSON.stringify({
											title: task.title,
											description: task.description,
											due_date: task.due_date,
											status: newStatus, //  status is flipped
										}),
									})

									if (res.ok) {
										const updated = await res.json()
										setTasks(prev => prev.map(t => (t.id === updated.id ? updated : t)))
									} else {
										alert('Failed to update task status')
									}
								}}

								className={`hidden md:inline-block text-sm px-6 py-2 rounded-full hover:scale-105 transition duration-300 shadow-md font-bold cursor-pointer ${task.status === 'done' ? 'bg-green-500 text-white' : 'bg-yellow-400 text-black'
									}`}
							>
								{task.status === 'done' ? 'Done üéâ' : 'Pending ‚è≥'}
							</button>

						</div>



					</div>




				))}
			</div>

			{/* Add Task Moddel */}
			{showModal && (
				<div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
					<div className="bg-white p-8 rounded-2xl shadow-md w-full max-w-md">
						<h2 className="text-xl font-bold mb-4 font-mono text-gray-700">Add New Task</h2>

						<div className="space-y-4">

							{addError && (
								<p className="text-red-500 text-sm text-center mb-2">{addError}</p>
							)}
							<input
								type="text"
								placeholder="Title"
								value={newTask.title}
								onChange={e => setNewTask({ ...newTask, title: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-pink-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
							/>
							<input
								type="text"
								placeholder="Description"
								value={newTask.description}
								onChange={e => setNewTask({ ...newTask, description: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-pink-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
							/>
							<input
								type="date"
								value={newTask.due_date}
								onChange={e => setNewTask({ ...newTask, due_date: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-pink-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
							/>

							<div className="flex justify-end space-x-2 pt-4">
								<button
									onClick={() => setShowModal(false)}
									className="px-4 py-3 rounded-full bg-gray-400 text-white text-sm shadow-md font-bold hover:brightness-110 transition duration-200"
								>
									Cancel
								</button>
								<button
									onClick={handleAddTask}
									className="px-4 py-3 rounded-full bg-pink-500 text-white text-sm shadow-md font-bold hover:brightness-110 transition duration-200"
								>
									Add Task
								</button>
							</div>
						</div>
					</div>
				</div>
			)}

			{editModalTask && (
				<div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
					<div className="bg-white p-8 rounded-2xl shadow-md w-full max-w-md">
						<h2 className="text-xl font-bold mb-4 font-mono text-gray-700">Edit Task</h2>

						<div className="space-y-4">

							{editError && (
								<p className="text-red-500 text-sm text-center mb-2">{editError}</p>
							)}
							<input
								type="text"
								placeholder='Title'
								value={editForm.title}
								onChange={e => setEditForm({ ...editForm, title: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-green-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
							/>
							<input
								type="text"
								placeholder='Description'
								value={editForm.description}
								onChange={e => setEditForm({ ...editForm, description: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-green-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
							/>
							<input
								type="date"
								value={editForm.due_date}
								onChange={e => setEditForm({ ...editForm, due_date: e.target.value })}
								className="mt-1 w-full px-3 py-2 border border-green-300 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
							/>

							<div className="flex pt-4 justify-end gap-2">
								<button
									onClick={() => setEditModalTask(null)}
									className="px-4 py-3 rounded-full bg-gray-400 text-white text-sm shadow-md font-bold hover:brightness-110 transition duration-200"
								>
									Cancel
								</button>

								<button
									onClick={async () => {
										if (!editModalTask) return

										// Validation
										if (!editForm.title.trim() || !editForm.description.trim() || !editForm.due_date) {
											setEditError("All fields are required.")
											return
										}

										const token = localStorage.getItem('token')
										setEditError('')  // Clear any old error

										try {

											const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks/${editModalTask.id}`, {
												method: 'PUT',
												headers: {
													'Content-Type': 'application/json',
													Authorization: `Bearer ${token}`,
												},
												body: JSON.stringify({
													...editForm,
													status: editModalTask.status,
												}),
											})
											if (!res.ok) {
												const data = await res.json()
												setEditError(data.detail || 'Update failed')  // Show backend error
												return
											}

											const updated = await res.json()
											setTasks(prev => prev.map(t => (t.id === updated.id ? updated : t)))
											setEditModalTask(null)
										} catch {
											setEditError('Something went wrong')
										}
									}}
									className="px-4 py-3 rounded-full bg-green-500 text-white text-sm shadow-md font-bold hover:brightness-110 transition duration-200"
								>
									Save
								</button>
							</div>
						</div>
					</div>
				</div>
			)}

			{showDeleteModal && (
				<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
					<div className="bg-white rounded-xl shadow-lg p-6 w-[90%] max-w-sm text-center">
						<h3 className="text-lg font-mono text-gray-700 font-semibold mb-4">
							Are you sure to delete this task?
						</h3>
						<div className="flex justify-between space-x-4 mt-6">
							<button
								onClick={() => setShowDeleteModal(false)}
								className="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-black w-full"
							>
								Cancel
							</button>
							<button
								onClick={async () => {
									const token = localStorage.getItem('token');
									if (!token || !taskToDelete) return;

									const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/tasks/${taskToDelete}`, {
										method: 'DELETE',
										headers: {
											Authorization: `Bearer ${token}`,
										},
									});

									if (res.ok) {
										setTasks((prev) => prev.filter((t) => t.id !== taskToDelete));
									} else {
										alert('Failed to delete task.');
									}

									setShowDeleteModal(false);
									setTaskToDelete(null);
								}}
								className="px-4 py-2 rounded bg-red-500 hover:bg-red-600 text-white w-full"
							>
								OK
							</button>
						</div>
					</div>
				</div>
			)}




		</div>
	)
}

